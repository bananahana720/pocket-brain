name: CI/CD VPS

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      with_worker:
        description: Also deploy Cloudflare Worker
        required: false
        default: false
        type: boolean
      skip_pull:
        description: Skip pull inside remote deploy (recommended true with sync step)
        required: false
        default: true
        type: boolean
      ready_retries:
        description: Override readiness retries
        required: false
        default: "30"
        type: string
      ready_delay_seconds:
        description: Override readiness delay seconds
        required: false
        default: "2"
        type: string

permissions:
  contents: read

jobs:
  ci:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install server dependencies
        run: npm ci --prefix server

      - name: Validate runtime config guards (production baseline)
        env:
          NODE_ENV: production
          KEY_ENCRYPTION_SECRET: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
          STREAM_TICKET_SECRET: bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
          ALLOW_INSECURE_DEV_AUTH: "false"
          REQUIRE_REDIS_FOR_READY: "true"
          CORS_ORIGIN: https://app.pocketbrain.example
          CLERK_SECRET_KEY: sk_test_example
          CLERK_PUBLISHABLE_KEY: pk_test_example
          WORKER_ROUTE_MODE: dashboard
          VPS_API_ORIGIN: https://example.com
        run: npm run config:check

      - name: Build frontend
        run: npm run build

      - name: Build backend
        run: npm run server:build

      - name: Test backend
        run: npm run server:test

  deploy_vps:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: ci
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
    timeout-minutes: 40
    environment: production
    concurrency:
      group: vps-production-deploy
      cancel-in-progress: false
    env:
      VPS_SSH_HOST: ${{ secrets.VPS_SSH_HOST }}
      VPS_PROJECT_DIR: ${{ secrets.VPS_PROJECT_DIR }}
      VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT || '22' }}
      VPS_SSH_RETRY_ATTEMPTS: ${{ vars.VPS_SSH_RETRY_ATTEMPTS || '3' }}
      VPS_READY_RETRIES: ${{ vars.VPS_READY_RETRIES || '30' }}
      VPS_READY_DELAY_SECONDS: ${{ vars.VPS_READY_DELAY_SECONDS || '2' }}
      VPS_POSTGRES_READY_RETRIES: ${{ vars.VPS_POSTGRES_READY_RETRIES || '20' }}
      VPS_POSTGRES_READY_DELAY_SECONDS: ${{ vars.VPS_POSTGRES_READY_DELAY_SECONDS || '2' }}
      VPS_SSH_IDENTITY: ~/.ssh/id_ed25519
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Evaluate deploy prerequisites
        id: deploy_gate
        env:
          VPS_SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          missing=()
          for key in VPS_SSH_HOST VPS_PROJECT_DIR VPS_SSH_PRIVATE_KEY; do
            if [[ -z "${!key:-}" ]]; then
              missing+=("$key")
            fi
          done
          if (( ${#missing[@]} > 0 )); then
            printf 'enabled=false\n' >> "$GITHUB_OUTPUT"
            printf 'missing=%s\n' "${missing[*]}" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          printf 'enabled=true\n' >> "$GITHUB_OUTPUT"
          printf 'missing=\n' >> "$GITHUB_OUTPUT"

      - name: Skip deploy (missing secrets)
        if: ${{ steps.deploy_gate.outputs.enabled != 'true' }}
        run: |
          echo "Skipping VPS deploy because required secrets are missing: ${{ steps.deploy_gate.outputs.missing }}"

      - name: Setup Node
        if: ${{ steps.deploy_gate.outputs.enabled == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        if: ${{ steps.deploy_gate.outputs.enabled == 'true' }}
        run: npm ci

      - name: Install server dependencies
        if: ${{ steps.deploy_gate.outputs.enabled == 'true' }}
        run: npm ci --prefix server

      - name: Configure SSH key and known_hosts
        if: ${{ steps.deploy_gate.outputs.enabled == 'true' }}
        env:
          VPS_SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s' "$VPS_SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          host="${VPS_SSH_HOST#*@}"
          ssh-keyscan -p "$VPS_SSH_PORT" -H "$host" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Apply manual dispatch overrides
        if: ${{ steps.deploy_gate.outputs.enabled == 'true' && github.event_name == 'workflow_dispatch' }}
        run: |
          set -euo pipefail
          echo "VPS_READY_RETRIES=${{ inputs.ready_retries }}" >> "$GITHUB_ENV"
          echo "VPS_READY_DELAY_SECONDS=${{ inputs.ready_delay_seconds }}" >> "$GITHUB_ENV"

      - name: Determine deploy flags
        if: ${{ steps.deploy_gate.outputs.enabled == 'true' }}
        id: deploy_flags
        run: |
          set -euo pipefail
          flags=(--skip-pull)
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ inputs.skip_pull }}" != "true" ]]; then
              flags=()
            fi
            if [[ "${{ inputs.with_worker }}" == "true" ]]; then
              flags+=(--with-worker)
            fi
          fi
          printf 'value=%s\n' "${flags[*]}" >> "$GITHUB_OUTPUT"

      - name: Remote precheck
        if: ${{ steps.deploy_gate.outputs.enabled == 'true' }}
        run: npm run vps:precheck:remote

      - name: Remote sync
        if: ${{ steps.deploy_gate.outputs.enabled == 'true' }}
        run: npm run vps:sync:remote

      - name: Assert remote revision matches workflow SHA
        if: ${{ steps.deploy_gate.outputs.enabled == 'true' && github.event_name == 'push' }}
        env:
          WORKFLOW_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          remote_sha="$(ssh -i "$VPS_SSH_IDENTITY" -p "$VPS_SSH_PORT" -o BatchMode=yes -o ConnectTimeout=10 "$VPS_SSH_HOST" "set -euo pipefail; cd \"$VPS_PROJECT_DIR\"; git rev-parse HEAD")"
          echo "Remote SHA after sync: $remote_sha"
          echo "Workflow SHA: $WORKFLOW_SHA"
          if [[ "$remote_sha" != "$WORKFLOW_SHA" ]]; then
            echo "Remote SHA drift detected after sync; refusing deploy." >&2
            exit 1
          fi

      - name: Remote deploy
        if: ${{ steps.deploy_gate.outputs.enabled == 'true' }}
        env:
          DEPLOY_FLAGS: ${{ steps.deploy_flags.outputs.value }}
        run: |
          set -euo pipefail
          if [[ -n "$DEPLOY_FLAGS" ]]; then
            npm run vps:deploy:remote -- $DEPLOY_FLAGS
          else
            npm run vps:deploy:remote
          fi

      - name: Remote verify
        if: ${{ steps.deploy_gate.outputs.enabled == 'true' }}
        run: npm run vps:verify:remote
