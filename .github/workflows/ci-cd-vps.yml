name: CI/CD VPS

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      with_worker:
        description: Also deploy Cloudflare Worker
        required: false
        default: false
        type: boolean
      skip_pull:
        description: Skip pull inside remote deploy (recommended true with sync step)
        required: false
        default: true
        type: boolean
      ready_retries:
        description: Override readiness retries
        required: false
        default: "30"
        type: string
      ready_delay_seconds:
        description: Override readiness delay seconds
        required: false
        default: "2"
        type: string

permissions:
  contents: read

jobs:
  ci:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install server dependencies
        run: npm ci --prefix server

      - name: Build frontend
        run: npm run build

      - name: Build backend
        run: npm run server:build

      - name: Test backend
        run: npm run server:test

  deploy_vps:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: ci
    if: ${{ (github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')) && secrets.VPS_SSH_HOST != '' && secrets.VPS_PROJECT_DIR != '' && secrets.VPS_SSH_PRIVATE_KEY != '' }}
    timeout-minutes: 40
    environment: production
    concurrency:
      group: vps-production-deploy
      cancel-in-progress: false
    env:
      VPS_SSH_HOST: ${{ secrets.VPS_SSH_HOST }}
      VPS_PROJECT_DIR: ${{ secrets.VPS_PROJECT_DIR }}
      VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT || '22' }}
      VPS_SSH_RETRY_ATTEMPTS: ${{ vars.VPS_SSH_RETRY_ATTEMPTS || '3' }}
      VPS_READY_RETRIES: ${{ vars.VPS_READY_RETRIES || '30' }}
      VPS_READY_DELAY_SECONDS: ${{ vars.VPS_READY_DELAY_SECONDS || '2' }}
      VPS_POSTGRES_READY_RETRIES: ${{ vars.VPS_POSTGRES_READY_RETRIES || '20' }}
      VPS_POSTGRES_READY_DELAY_SECONDS: ${{ vars.VPS_POSTGRES_READY_DELAY_SECONDS || '2' }}
      VPS_SSH_IDENTITY: ~/.ssh/id_ed25519
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install server dependencies
        run: npm ci --prefix server

      - name: Validate required deployment secrets
        env:
          VPS_SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          missing=()
          for key in VPS_SSH_HOST VPS_PROJECT_DIR VPS_SSH_PRIVATE_KEY; do
            if [[ -z "${!key:-}" ]]; then
              missing+=("$key")
            fi
          done
          if (( ${#missing[@]} > 0 )); then
            echo "Missing required repo secrets: ${missing[*]}" >&2
            exit 1
          fi

      - name: Configure SSH key and known_hosts
        env:
          VPS_SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s' "$VPS_SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          host="${VPS_SSH_HOST#*@}"
          ssh-keyscan -p "$VPS_SSH_PORT" -H "$host" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Apply manual dispatch overrides
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          set -euo pipefail
          echo "VPS_READY_RETRIES=${{ inputs.ready_retries }}" >> "$GITHUB_ENV"
          echo "VPS_READY_DELAY_SECONDS=${{ inputs.ready_delay_seconds }}" >> "$GITHUB_ENV"

      - name: Determine deploy flags
        id: deploy_flags
        run: |
          set -euo pipefail
          flags=(--skip-pull)
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ inputs.skip_pull }}" != "true" ]]; then
              flags=()
            fi
            if [[ "${{ inputs.with_worker }}" == "true" ]]; then
              flags+=(--with-worker)
            fi
          fi
          printf 'value=%s\n' "${flags[*]}" >> "$GITHUB_OUTPUT"

      - name: Remote precheck
        run: npm run vps:precheck:remote

      - name: Remote sync
        run: npm run vps:sync:remote

      - name: Remote deploy
        env:
          DEPLOY_FLAGS: ${{ steps.deploy_flags.outputs.value }}
        run: |
          set -euo pipefail
          if [[ -n "$DEPLOY_FLAGS" ]]; then
            npm run vps:deploy:remote -- $DEPLOY_FLAGS
          else
            npm run vps:deploy:remote
          fi

      - name: Remote verify
        run: npm run vps:verify:remote
